# 批量子图位姿优化功能

## 概述

新增的 `--submap -1` 选项允许您自动处理文件夹中的所有子图，并将所有结果绘制在一张综合图中。这个功能特别适用于：

- 评估优化算法的整体性能
- 比较不同优化策略的效果
- 生成批量测试报告
- 分析子图位姿优化的统计特性

## 使用方法

### 基本批量优化

```bash
python optimize_submap.py data/1_rtk --submap -1
```

这将处理 `data/1_rtk` 文件夹中的所有子图，使用默认的粒子滤波优化策略。

### 多分辨率批量优化

```bash
python optimize_submap.py data/1_rtk --submap -1 --multi-res 5
```

使用5层多分辨率策略进行批量优化。

### 似然优化批量处理

```bash
python optimize_submap.py data/1_rtk --submap -1 --likelihood --candidates 3
```

使用似然地图优化策略，每个分辨率层使用3个候选位姿。

### 添加噪声的批量测试

```bash
python optimize_submap.py data/1_rtk --submap -1 --add-noise 0.5 10
```

为所有子图的初始位姿添加0.5米的位置噪声和10度的角度噪声。

### 使用真值位姿

```bash
python optimize_submap.py data/1_rtk --submap -1 --use-gt
```

使用 `path_pg_rtk.txt` 中的真值位姿作为参考。

## 输出结果

批量优化完成后，会生成两个独立的可视化窗口：

### 1. 主图窗口
- 显示所有子图的初始位置（蓝色）
- 显示所有子图的优化后位置（红色）
- 显示所有子图的真值位置（绿色）
- 背景显示全局地图的占用情况
- 包含详细的图例说明

### 2. 误差统计窗口
- **误差统计表格**：每个子图的初始误差和优化后误差，改善率百分比，平均误差统计
- **位姿误差统计**：位置误差的平均值和标准差，角度误差的平均值和标准差，改善情况的统计信息

## 性能特点

### 批量处理优化
- 自动跳过处理失败的子图，继续处理其他子图
- 批量处理时关闭中间过程可视化，提高处理速度
- 提供详细的进度信息和错误处理

### 内存管理
- 逐个处理子图，避免内存溢出
- 及时释放不需要的数据结构

### 错误处理
- 对每个子图的处理都有独立的异常捕获
- 提供详细的错误信息，便于调试

## 测试脚本

使用提供的测试脚本验证功能：

```bash
python test_batch_optimization.py
```

测试脚本会自动：
1. 检测可用的数据文件夹
2. 运行多种批量优化配置
3. 验证功能是否正常工作

## 注意事项

1. **处理时间**：批量处理可能需要较长时间，具体取决于子图数量和优化策略
2. **内存使用**：建议在内存充足的环境中运行
3. **可视化**：批量处理时不会显示中间过程，只显示最终的综合结果
4. **错误处理**：如果某个子图处理失败，会跳过该子图并继续处理其他子图

## 示例输出

```
处理所有子图，共 24 个
==================================================
处理子图 0 (1/24)
==================================================
子图 0 优化完成，最终误差: 0.123

==================================================
处理子图 1 (2/24)
==================================================
子图 1 优化完成，最终误差: 0.089

...

==================================================
所有子图处理完成，共成功处理 24 个子图
==================================================
```

## 支持的优化策略

批量处理功能支持所有现有的优化策略：

- ✅ 单分辨率粒子滤波优化
- ✅ 多分辨率粒子滤波优化
- ✅ 单分辨率似然优化
- ✅ 多分辨率似然优化
- ✅ 噪声添加功能
- ✅ 真值位姿使用
- ✅ 调试模式 